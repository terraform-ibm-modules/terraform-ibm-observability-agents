apiVersion: v1
kind: ConfigMap
metadata:
  name: cloud-monitoring-agent
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: cloud-monitoring-agent
    app.kubernetes.io/instance: cloud-monitoring-agent
    app.kubernetes.io/version: {{ .Values.image.version }}
  annotations:
    {{- range .Values.checkov_skips }}
    {{- . | toYaml | nindent 4 -}}
    {{- end }}
data:
  dragent.yaml: |
    configmap: true

    new_k8s: true
    k8s_cluster_name: {{ .Values.config.clustername }}

    ### Agent tags
    tags: ibm.containers-kubernetes.cluster.name:{{ .Values.config.clustername }}

    #### Cloud Monitoring Software related config ####

    # Cloud Monitoring collector address
    collector: ingest.private.{{ .Values.config.region }}.monitoring.cloud.ibm.com

    # Collector TCP port
    collector_port: 6443

    # Whether collector accepts ssl
    ssl: true

    # collector certificate validation
    ssl_verify_certificate: true

    {{ if .Values.metrics_filter -}}
    # metrics that must be included/excluded during the metrics collection
    metrics_filter:
      {{ range $v := .Values.metrics_filter -}}
      - {{ $v.type }}: {{ $v.name }}
      {{ end }}
    {{- end -}}
